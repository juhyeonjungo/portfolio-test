<script setup lang="ts">
import axios from "axios";
import { VDataTable } from "vuetify/lib/labs/VDataTable/index.mjs";
import { budgetStore } from "@/store/account/budget";
import { searchBudgeStatus } from "@/api/account/budget";

// refÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÏùò

const isDialogVisible = ref(false);
const isDialogVisible2 = ref(false);

const periodList = ref([]);
const workplaceList = ref([]);
const searchBudgetStatus = ref([]);
const searchComparisonBudget = ref([]);
const filteredDeptList = ref([]);

const year = ref(null);
const yeardata = ref([]);
const accountPeriodNo = ref("");
const workplaceCode = ref("");
const workplaceCode2 = ref("");
const workplaceName = ref("");
const workplaceName2 = ref("");
const deptName = ref("");
const deptCode = ref("");
const deptList = ref([]);
const deptInfo = ref([]);
const accountInnerCode = ref("");

const tableData = ref([]);
const selectedIndex = ref(-1); // ÏÑ†ÌÉùÎêú ÌñâÏùò Ïù∏Îç±Ïä§
const hoveredIndex = ref(-1); // ÎßàÏö∞Ïä§Í∞Ä ÏúÑÏóê ÏûàÏùÑ Îïå ÌñâÏùò Ïù∏Îç±Ïä§
const sum_budgetStatus = ref([]);
const sum_abr = ref(0);
const sum_annualBudget = ref(0);
const sum_remainingBudget = ref(0);
const budgetExecRate = ref("");
const sum_ambr = ref(0);
const sum_budget = ref(0);
const sum_remainingMonthBudget = ref(0);
const monthBudgetExecRate = ref("");

// ÏòàÏÇ∞ Ïã§Ï†Å ÎåÄÎπÑ Îç∞Ïù¥ÌÑ∞
const columns = [
  { title: "Íµ¨Î∂Ñ", key: "budgetDate" },
  { title: "Ïã†Ï≤≠ÏòàÏÇ∞", key: "appBudget" },
  { title: "Ìé∏ÏÑ±ÏòàÏÇ∞", key: "orgBudget" },
  { title: "ÏßëÌñâÏã§Ï†Å", key: "execPerform" },
  { title: "ÏòàÏã§ÎåÄÎπÑ", key: "budgetAccountComparison" },
];

// ÌöåÍ≥ÑÏó∞ÎèÑ Ï°∞Ìöå Ïãú Îç∞Ïù¥ÌÑ∞
const headers3 = [
  { title: "ÌöåÍ≥Ñ ÏãúÏûëÏùºÏûê", sortable: false, key: "periodStartDate" },
  { title: "ÌöåÍ≥Ñ Ï¢ÖÎ£åÏùºÏûê", key: "periodEndDate" },
  { title: "Í∏∞Í∞ÑÎ≤àÌò∏", key: "accountPeriodNo" },
];

// ÏÇ¨ÏóÖÏû• Ï°∞Ìöå Ïãú Îç∞Ïù¥ÌÑ∞
const headers4 = [
  { title: "ÏÇ¨ÏóÖÏû•ÏΩîÎìú", sortable: false, key: "workplaceCode" },
  { title: "ÏÇ¨ÏóÖÏû•Î™Ö", key: "workplaceName" },
];

// Î∂ÄÏÑú Ï°∞Ìöå Ïãú Îç∞Ïù¥ÌÑ∞
const headers5 = [
  { title: "Î∂ÄÏÑúÏΩîÎìú", sortable: false, key: "deptCode" },
  { title: "Î∂ÄÏÑúÎ™Ö", key: "deptName" },
];

// ÌöåÍ≥ÑÏó∞ÎèÑ Ï°∞ÌöåÏãú ÌïÑÏöîÌïú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò¥
const fetchData = async () => {
  try {
    const response = await axios.get(
      "http://localhost:8282/acc/budget/periodNoList"
    );

    console.log("responseüëâüëâüëâ", response.data.periodList);

    return response.data.periodList; // companyInfo Î∞∞Ïó¥ÏùÑ Î∞òÌôò
  } catch (error) {
    console.error("Error fetching data:", error);

    return [];
  }
};

// ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉùÏãú Î∂ÄÏÑúÎ¶¨Ïä§Ìä∏ Ï∂úÎ†•
const fetchData2 = async () => {
  try {
    const response = await axios.get(
      "http://localhost:8282/acc/operate/deptList"
    );

    console.log("deptList", response.data.deptList);

    const deptData = response.data.deptList;

    deptList.value = deptData.map((e: any) => ({
      value: e.workplaceCode,
      text: e.workplaceName,
    }));

    console.log("deptList.value", deptList.value);

    return response.data.deptList; // companyInfo Î∞∞Ïó¥ÏùÑ Î∞òÌôò
  } catch (error) {
    console.error("Error fetching data:", error);

    return [];
  }
};

// Î∂ÄÏÑúÎ™Ö Ï°∞ÌöåÌï† Îïå Î∂ÄÏÑúÎ¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò¥
const fetchData3 = async (workplaceCode2: any) => {
  console.log("workplaceCode2", workplaceCode2);
  try {
    const response = await axios.get(
      "http://localhost:8282/acc/operate/detailDeptList",
      { params: { workplaceCode: workplaceCode2 } }
    );

    console.log("response", response);
    deptInfo.value = response.data.detailDeptList;
    deptName.value = response.data.detailDeptList.deptName;
    deptCode.value = response.data.detailDeptList.deptCode;

    return response.data.detailDeptList;
  } catch (error) {
    console.error("Error fetching data:", error);

    return [];
  }
};

// Í≥ÑÏ†ïÍ≥ºÎ™© Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò¥
const fetchData4 = async () => {
  try {
    const response = await axios.get(
      "http://localhost:8282/acc/base/parentAccountList"
    );

    console.log("responseeeee", response);

    accountCodeListTest.value = response.data.accountCodeList;

    return response.data;
  } catch (error) {
    console.error("Error fetching data:", error);

    return [];
  }
};

watch(
  () => workplaceCode2.value,
  (newVal, oldVal) => {
    fetchData3(newVal);
  }
);

watch(
  () => accountInnerCode.value,
  (newVal, oldVal) => {
    fetchData5(newVal);
  }
);

/* ÌöåÍ≥ÑÏó∞ÎèÑ Ï°∞Ìöå */
const onSelected = (selected: any, a: any) => {
  year.value = new Date(a.internalItem.columns.periodStartDate).getFullYear();

  accountPeriodNo.value = a.internalItem.columns.accountPeriodNo;
};

// ÏÇ¨ÏóÖÏû•Î™Ö Ï°∞Ìöå
const onSelected2 = (selected: any, b: any) => {
  console.log("b", b);

  const workplaceCode = b.internalItem.columns.workplaceCode;
  const workplaceName = b.internalItem.columns.workplaceName;

  console.log("üëâüëâüëâ", workplaceCode, workplaceName);

  workplaceCode2.value = workplaceCode;
  workplaceName2.value = workplaceName;
};

// Î∂ÄÏÑúÎ™Ö Ï°∞Ìöå
const onSelected3 = (selected: any, c: any) => {
  deptName.value = c.internalItem.columns.deptName;
  deptCode.value = c.internalItem.columns.deptCode;
  console.log("c", c);
  fetchData4();
};

// ÏòàÏÇ∞ Ïã§Ï†Å Ï°∞ÌöåÏãú ÌïÑÏöîÌïú Îç∞ÏûçÌÑ∞ Ìï®Ïàò (Î≠êÍ∞Ä Ï¢Ä ÎßéÏùå)
// Ìï©Í≥Ñ Í∞íÏùÑ Í≥ÑÏÇ∞ÌïòÍ≥† Í∞Å Î≥ÄÏàòÏóê Ìï†ÎãπÌïòÎäî Ìï®Ïàò
const setValues = () => {
  budgetExecRate.value =
    sum_annualBudget.value === 0
      ? "-"
      : ((sum_abr.value / sum_annualBudget.value) * 100).toFixed(3);
  monthBudgetExecRate.value =
    sum_budget.value === 0
      ? "-"
      : ((sum_ambr.value / sum_budget.value) * 100).toFixed(3);

  // Í∞Å Ìï≠Î™©Ïù¥ 0Ïùº Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
  sum_abr.value = sum_abr.value || 0;
  sum_annualBudget.value = sum_annualBudget.value || 0;
  sum_remainingBudget.value = sum_remainingBudget.value || 0;
  sum_ambr.value = sum_ambr.value || 0;
  sum_budget.value = sum_budget.value || 0;
  sum_remainingMonthBudget.value = sum_remainingMonthBudget.value || 0;
};

// ÏòàÏÇ∞ Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ Ìï®Ïàò
const getPinnedBottomRowData = (budgetStatus: any) => {
  console.log("budgetStatus", budgetStatus);
  if (!budgetStatus) return [];

  // Í∞Å Ìï≠Î™©ÏùÑ ÎçîÌïòÍ∏∞
  for (let i = 0; i < budgetStatus.length; i++) {
    sum_abr.value += budgetStatus[i].abr;
    sum_annualBudget.value += budgetStatus[i].annualBudget;
    sum_remainingBudget.value += budgetStatus[i].remainingBudget;
    sum_ambr.value += budgetStatus[i].ambr;
    sum_budget.value += budgetStatus[i].monthBudget;
    sum_remainingMonthBudget.value += budgetStatus[i].remainingMonthBudget;
  }

  // Í∞Å Ìï≠Î™©Ïóê ÎåÄÌïú Í≥ÑÏÇ∞ÏùÑ ÏàòÌñâÌï©ÎãàÎã§.
  setValues();
};

// ÏòàÏÇ∞Ïã§Ï†ÅÏ°∞Ìöå Î≤ÑÌäº Ïã§Ìñâ
const searchBudget = async () => {
  const data = {
    periodNo: accountPeriodNo.value,
    workplaceCode: workplaceCode.value,
    deptCode: deptCode.value,
  };
  const response = await searchBudgeStatus(data);
  const commit = commit("SEARCH_BUDGET_STATUS", response.data.budgetStatusList);

  await budgetStore().SEARCH_BUDGET_STATUS_REQUEST(commit, data);

  console.log("searchBudgetStatus Í∞í ÎÇòÏò§ÎÇò", searchBudgetStatus.value);
  getPinnedBottomRowData(searchBudgetStatus.value);
};

onMounted(async () => {
  yeardata.value = await fetchData();
  workplaceName.value = await fetchData2();
});
</script>

<!-- UI Ï∂úÎ†• ÌÖúÌîåÎ¶ø ÏÑ§Ï†ï -->
<template>
  <!-- Ï≤´Î≤àÏß∏ Ïª¥Ìè¨ÎÑåÌä∏ -->
  <div>
    <VCard class="mt-2">
      <VRow>
        <VCol class="mt-4" cols="12" md="2">
          <VTextField
            ref="inputYear"
            v-model="year"
            placeholder="ÌöåÍ≥ÑÏó∞ÎèÑ"
            class="form-control"
            label="ÌöåÍ≥ÑÏó∞ÎèÑ"
          />
        </VCol>

        <VCol class="mt-4" cols="12" md="1">
          <VDialog v-model="isDialogVisible" width="500">
            <template #activator="{ props }">
              <IconBtn class="me-1" @click="Shepherd.activeTour?.cancel()">
                <VIcon v-bind="props" size="26" icon="tabler-search" />
              </IconBtn>
            </template>
            <DialogCloseBtn @click="isDialogVisible = !isDialogVisible" />

            <!-- Dialog Content -->
            <VCard title="ÌöåÍ≥ÑÏó∞ÎèÑ">
              <VContainer>
                <VDataTable
                  :key="(row: any) => row.id"
                  :headers="headers3"
                  :items="yeardata"
                  :items-per-page="5"
                  selectable
                  select-mode="single"
                  @click:row="onSelected"
                />
                <VCardText class="d-flex justify-end">
                  <VBtn @click="isDialogVisible = false"> OK </VBtn>
                </VCardText>
              </VContainer>
            </VCard>
          </VDialog>

          <p class="h4 mb-4">
            <VIcon v-b-modal.searchYear style="height: 70px" icon="search" />
          </p>
        </VCol>

        <VCol class="mt-4" cols="12" md="3">
          <VTextField
            v-model="workplaceName2"
            placeholder="ÏÇ¨ÏóÖÏû•Î™Ö"
            label="ÏÇ¨ÏóÖÏû•Î™Ö"
          />
        </VCol>

        <VCol class="mt-4" cols="12" md="3">
          <VTextField v-model="deptName" placeholder="Î∂ÄÏÑúÎ™Ö" label="Î∂ÄÏÑúÎ™Ö" />
        </VCol>
        <VCol class="mt-4" cols="12" md="1">
          <VDialog v-model="isDialogVisible2" width="500">
            <template #activator="{ props }">
              <IconBtn class="me-1" @click="Shepherd.activeTour?.cancel()">
                <VIcon v-bind="props" size="26" icon="tabler-search" />
              </IconBtn>
            </template>

            <DialogCloseBtn @click="isDialogVisible2 = !isDialogVisible2" />
            <!-- Dialog Content -->
            <VCard title="ÏÇ¨ÏóÖÏû•/Î∂ÄÏÑú ÏÑ†ÌÉù">
              <VContainer>
                <VDataTable
                  :headers="headers4"
                  :items="workplaceName"
                  :items-per-page="5"
                  @click:row="onSelected2"
                />
                <VDataTable
                  :headers="headers5"
                  :items="deptInfo"
                  :items-per-page="5"
                  @click:row="onSelected3"
                />

                <VCardText class="d-flex justify-end">
                  <VBtn @click="isDialogVisible2 = false"> OK </VBtn>
                </VCardText>
              </VContainer>
            </VCard>
          </VDialog>
        </VCol>

        <VCol class="mb-1" cols="12" md="2">
          <p style="margin-top: 17px">
            <VBtn @click="searchBudget"> ÏòàÏÇ∞Ïã§Ï†ÅÏ°∞Ìöå </VBtn>
          </p>
        </VCol>
      </VRow>
    </VCard>
    <div>
      <table :show-footer="true">
        <thead>
          <tr>
            <th colspan="2">Í≥ÑÏ†ï</th>
            <th colspan="4">ÎàÑÍ≥ÑÏòàÏÇ∞ÎåÄÎπÑÏã§Ï†Å</th>
            <th colspan="4">ÎãπÏõîÏòàÏÇ∞ÎåÄÎπÑÏã§Ï†Å</th>
          </tr>
          <tr>
            <th>Í≥ÑÏ†ïÍ≥ºÎ™©ÏΩîÎìú</th>
            <th>Í≥ÑÏ†ïÍ≥ºÎ™©Î™Ö</th>
            <th>Ïã§Ï†Å</th>
            <th>ÏòàÏÇ∞</th>
            <th>ÏûîÏó¨ÏòàÏÇ∞</th>
            <th>ÏßëÌñâÏú®(%)</th>
            <th>Ïã§Ï†Å</th>
            <th>ÏòàÏÇ∞</th>
            <th>ÏûîÏó¨ÏòàÏÇ∞</th>
            <th>ÏßëÌñâÏú®(%)</th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="(item, index) in searchBudgetStatus"
            :key="index"
            :value="item.accountInnerCode"
            :class="{
              selected: selectedIndex === index,
              hovered: hoveredIndex === index,
            }"
            @click="rowSelect(item)"
            @mouseover="hoveredIndex = index"
            @mouseleave="hoveredIndex = -1"
          >
            <td class="center">
              {{ item.accountInnerCode }}
            </td>
            <td class="center">
              {{ item.accountName }}
            </td>
            <td class="center">
              {{ item.abr }}
            </td>
            <td class="center">
              {{ item.annualBudget }}
            </td>
            <td class="center">
              {{ item.remainingBudget }}
            </td>
            <td class="center">
              {{ item.budgetExecRate }}
            </td>
            <td class="center">
              {{ item.ambr }}
            </td>
            <td class="center">
              {{ item.budget }}
            </td>
            <td class="center">
              {{ item.remainingMonthBudget }}
            </td>
            <td class="center">
              {{ item.monthBudgetExecRate }}
            </td>
          </tr>
          <tr>
            <td colspan="2" class="center" style="background-color: darkgray">
              Ìï©Í≥Ñ
            </td>
            <td class="center">
              {{ sum_abr }}
            </td>
            <td class="center">
              {{ sum_annualBudget }}
            </td>
            <td class="center">
              {{ sum_remainingBudget }}
            </td>
            <td class="center">
              {{ budgetExecRate }}
            </td>
            <td class="center">
              {{ sum_ambr }}
            </td>
            <td class="center">
              {{ sum_budget }}
            </td>
            <td class="center">
              {{ sum_remainingMonthBudget }}
            </td>
            <td class="center">
              {{ monthBudgetExecRate }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div>
      <br />

      <h3>ÏòàÏÇ∞ Ïã§Ï†Å ÎåÄÎπÑ</h3>
      <VDataTable
        hover
        sticky-header="true"
        :headers="columns"
        :items="searchComparisonBudget"
        :fields="columns"
      />
    </div>
  </div>
</template>

<style scoped>
table {
  width: 100%;
  color: black;
}

th {
  border: 1px solid;
  text-align: center;
  background-color: lightgray;
}

td {
  border: 1px solid;
  text-align: center;
  background-color: white;
}

.selected {
  background-color: yellow;
}

.hovered {
  background-color: gray;
}
</style>
